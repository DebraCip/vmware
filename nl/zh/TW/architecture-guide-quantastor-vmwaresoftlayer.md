---
copyright:
  years: 1994, 2017
lastupdated: "2017-12-18"
---

{:shortdesc: .shortdesc}
{:new_window: target="_blank"}

# QuantaStor 架構手冊

您可以訂購及配置適用於 VMware ESXi 5 環境的 OSNexus QuantaStor 共用儲存空間解決方案。請搭配使用下列資訊與[進階單一網站 VMware 參照架構](/docs/infrastructure/virtualization/advanced-single-site-vmware-reference-architecturesoftlayer.html) 錦囊妙計，以在 VMware 環境中設定其中一個儲存空間選項。

## 步驟 1：訂購 QuantaStor 共用儲存空間

您需要先決定符合容量及 I/O 需求的規格，再訂購儲存空間。這些規格包括但不限於伺服器 RAM、磁碟機類型和數目、進行快取的 SSD、RAID 配置，以及網路配置。如需選擇環境中正確 QuantaStor 配置的相關資訊，請參閱 [QuantaStor 虛擬化解決方案設計手冊 ![外部鏈結圖示](../../icons/launch-glyph.svg "外部鏈結圖示")](http://wiki.osnexus.com/index.php?title=Solution_Design_Guide#Server_Virtualization){: new_window}。

針對範例環境，會使用較小的配置，以提供虛擬機器 (VM) 所需的足夠容量及 I/O。請確定先瞭解 VM 的容量及 I/O 需求，再進行訂購。QuantaStor 伺服器可擴充時，請務必一開始就調整硬體大小，以避免配置及部署延遲。

### 訂購 QuantaStor

使用下列步驟來訂購 QuantaStor 伺服器。

1. 登入 [{{site.data.keyword.slportal_full}} ![外部鏈結圖示](../../icons/launch-glyph.svg "外部鏈結圖示")](https://control.softlayer.com/){: new_window}，然後按一下**帳戶 > 訂購**。
2. 選取蹦現畫面上的「{{site.data.keyword.baremetal_short}}、每月」。
3. 從「伺服器清單」頁面中，選取可儲存您環境所需磁碟數目的適當伺服器。[針對範例環境，選取有 12 個磁碟機機槽的 12 核心系統（亦即，雙十六進位核心）。]
4. 輸入下列配置選項：
  * **資料中心：**先前建立的 VLAN 及 ESXi 主機的位置
  * **伺服器：**Dual Processor Hex Core Xeon
  * **RAM：**64 GB
  * **作業系統：**OSNexus QuantaStor 3.x (4 TB)
  * **硬碟：**
    * 磁碟 1 & 2：RAID 1 中的 500 GB SATA
    * 分割區範本：Linux Basic
    * 磁碟 3-10：RAID-10 中的 600 GB SAS 15K
  * **公用頻寬：**僅限專用網路
  * **上行鏈路埠速度：**10 Gbps 備援專用網路上行鏈路
5. 按一下**繼續訂購**。

**附註：**儲存空間伺服器已配置兩個未結合的網路介面，以使用兩個不同的子網路將資料流量負載平衡至儲存空間陣列。

### 完成配置

您的購物車中現在有一個 QuantaStor 應用裝置。您現在需要將專用 VLAN、主機名稱及網域指派給裝置，以正確進行佈建。

1. 指派下列 VLAN 並建立裝置的主機名稱：QuantaStor 主機 - 後端 VLAN：（環境中的 1102）
2. 選取您的付款方法，同意「條款」，然後按一下「完成訂單」。

**附註**：除非伺服器已佈建並且可以透過 VPN 或虛擬伺服器進行存取，否則不會繼續進行步驟 3。

## 步驟 2：為管理及容量主機啟用 iSCSI 軟體配接卡

必須在每一個管理及容量主機上啟用「iSCSI 軟體配接卡」，並且在裝載 iSCSI 磁區之前收集其「iSCSI 完整名稱 (IQN)」。使用下列步驟，以啟用 iSCSI 軟體配接卡：

1. 移至 ESXi 管理或容量主機，然後選取「管理」、「儲存空間」、「儲存空間配接卡」。
2. 按一下綠色加號 (+)，然後新增「iSCSI 軟體配接卡」。
3. 按一下對應於「iSCSI 軟體配接卡」的 vmhba，並在啟用之後，於「配接卡詳細資料」區段中記錄「iSCSI 名稱」（圖 1）。
4. 針對每一個 ESXi 管理及容量主機上的每一個「iSCSI 軟體配接卡」，執行步驟 1 - 3。

## 步驟 3：配置 QuantaStor

佈建伺服器之後，即可設定共用儲存裝置。具體而言，您可以設定網路並配置 iSCSI 磁區，然後將磁區指派給主機。 

例如，磁區 vmk3 的 vmnic0 會連接至儲存空間 VLAN 上的「可攜式專用子網路 A」。磁區 vmk4 的 vmnic2 會連接至儲存空間 VLAN 上的「可攜式專用子網路 B」。QuantaStor 伺服器也具有連接至儲存空間 VLAN 的兩個專用網路配接卡，即 eth4 及 eth6。

### 配置網路

1. 開啟 Web 瀏覽器，然後移至 [{{site.data.keyword.slportal_short}} ![外部鏈結圖示](../../icons/launch-glyph.svg "外部鏈結圖示")](https://control.softlayer.com/){: new_window} 的**裝置**頁面上所列的 QuantaStor IP 位址。
2. 輸入**管理使用者**及**密碼**（可在**裝置詳細資料**頁面的「密碼」區段中找到）。繼續之前，請注意 QuantaStor 伺服器所使用的專用網路裝置（例如 eth4）。
3. 移至**儲存空間系統 > 網路埠**。
4. 從網路配接卡清單中，選取作用中的專用配接卡（範例：eth4）。按一下滑鼠右鍵，然後從蹦現功能表中選取**修改網路埠**。
5. 清除**已啟用 iSCSI** 勾選框以停用與此配接卡的 iSCSI 連線，然後按一下**確定**。
6. 選取非作用中的專用配接卡，但會指派給專用網路（範例 eth6）。
7. 用滑鼠右鍵按一下 eth6 配接卡，然後從蹦現功能表中選取**修改網路埠**。
8. 在**修改網路埠**畫面上，將**配置類型**選取為**靜態**。
9. 輸入配接卡的主要專用 IP 位址、子網路及閘道。如果您要使用[進階單一網站 VMware 參照架構](/docs/infrastructure/virtualization/advanced-single-site-vmware-reference-architecturesoftlayer.html)錦囊妙計中的 VLAN 工作表，請使用「儲存空間」列中的位址。
10. 清除**已啟用 iSCSI** 勾選框以停用與此配接卡的 iSCSI 連線。
11. 用滑鼠右鍵按一下專用配接卡，然後在使用 IP 位址進行配置之後，選取**啟用網路埠**讓配接卡連線。
12. 按一下**確定**，以在驗證 IP 位址時啟用埠。

### 開立支援問題單

在配置具有主要專用 IP 位址的第二張配接卡之後，您需要開立支援問題單。如果在 VLAN 上佈建了另一部機器，則開立問題單有助於確認未採用您所使用的 IP 位址。

1. 按一下**支援** > **新增問題單**，然後輸入下列資訊：
  * 主旨：專用網路問題
  * 標題：保留及指派專用 IP 位址
  * 關聯裝置：「選取 QuantaStor 伺服器」
  * 詳細資料：VLAN 上的保留及指派。此 IP 位址用於 QuantaStor 伺服器上的第二張配接卡。

### 配置 QuantaStor

既然陣列可以接受來自兩張配接卡的連線，則必須指派「儲存空間路徑 A」及「儲存空間路徑 B」子網路上的配接卡虛擬介面。

  1. 用滑鼠右鍵按一下起始專用配接卡介面 (eth4)，然後在蹦現功能表上選取**建立虛擬介面**。
  2. 在產生的蹦現畫面上，輸入配接卡的可攜式專用 IP 位址及子網路，並確定已勾選**已啟用 iSCSI**。
  3. 如果您要使用 VLAN 工作表，請使用「儲存空間路徑 A」列中的位址。
  4. 在「可攜式 IP 位址」頁面上，記錄「附註」區段中所使用的 IP 位址。
  5. 選取起始專用配接卡介面 (eth4) 來連結虛擬介面，然後按一下**確定**。
  6. 用滑鼠右鍵按一下另一個專用配接卡介面 (eth6)，然後在蹦現功能表上選取**建立虛擬介面**。
  7. 在產生的蹦現畫面上，輸入配接卡的可攜式專用 IP 位址及子網路，並確定已勾選**已啟用 iSCSI**。
  8. 如果您要使用 VLAN 工作表，請使用「儲存空間路徑 B」列中的位址。
  9. 在「可攜式 IP 位址」頁面上，記錄「附註」區段中所使用的這個 IP 位址。
  10. 選取另一個專用配接卡介面 (eth6) 來連結虛擬介面，然後按一下**確定**。

使用 IP 位址及虛擬介面配置 QuantaStor 伺服器之後，您需要配置遞送以確保送出的資料流量使用正確的介面（因為有兩個 NIC 位在不同的子網路上）。

1. 使用根認證 SSH 至 QuantaStor 伺服器，並將下列這幾行附加至 /etc/network/interfaces。假設 eth4 及 eth6 是專用網路上的 NIC：
  * post-up ip route add 10.0.0.0/8 via dev eth4
  * post-up ip route add 10.0.0.0/8 via dev eth6 table eth6
  * post-up ip rule add from table eth6

### 建立儲存區

接下來，您必須先建立用來配置磁區的儲存區，才能建立磁區或共用。

1. 用滑鼠右鍵按一下**儲存區**，然後選取**建立儲存區**。
2. 在**建立儲存區**畫面上，輸入下列資訊：
  * 名稱：輸入儲存區的適當名稱。範例：StoragePool-01
  * 儲存區類型：預設值 (zfs)
  * I/O 設定檔：虛擬化
  * 要用於儲存區的磁碟：sdb
3. 按一下**確定**。

如果無法將 sdb 新增至儲存區，則原因是分割區已存在並且標示為可開機。您需要在 Quantastor 主控台上使用 gdisk，以移除分割區及任何 /etc/fstab 項目。接下來，您需要建立要供 ESXi 取用的磁區。

### 建立 iSCSI 儲存空間磁區

您需要建立兩個儲存空間磁區。一個磁區用於管理叢集上的管理 VM，另一個磁區則用於容量叢集上的 VM。完成下列步驟，以建立 iSCSI 儲存空間磁區：

1. 用滑鼠右鍵按一下**儲存空間磁區**，然後在蹦現功能表上選取**建立儲存空間磁區**
2. 輸入儲存空間磁區的資訊。**附註：**雖然配置會因工作負載及儲存空間容量而不同，但是此範例會在「表 1」及「表 2」中顯示每一個儲存空間磁區的值。

|欄位|值|
|---|---|
|名稱|Mgmt-LUN0|
|儲存區|[前一個步驟中配置的儲存區名稱]|
|大小|500GB|
|已保留百分比|50|
|壓縮|已啟用|
{: caption="表 1. iSCSI 管理磁區" caption-side="top"}

|欄位|值|
|---|---|
|名稱|Capacity-LUN0|
|儲存區|[前一個步驟中配置的儲存區名稱]|
|大小|3TB|
|已保留百分比|50|
|壓縮|已啟用|
{: caption="表 2. iSCSI 容量磁區" caption-side="top"}

### 將主機存取權指派給磁區

您需要配置 QuantaStor，以容許在設定磁區之後，透過每一個主機的 IQN 從 ESXi 主機存取磁區。

1. 導覽至 QuantaStor 管理頁面，用滑鼠右鍵按一下**主機**功能表，然後選取**新增主機**。
2. 在**新增主機**畫面上，輸入下列資訊：
  * 主機名稱：輸入適當的主機名稱。主機名稱沒有完整網域名稱 (FQDN)，但應該說明主機。範例：MyESXiHostName
  * 作業系統類型：VMware
  * 起始者：「iSCSI 完整名稱 (IQN)」圓鈕
  * iSCSI 完整名稱：個別主機的 IQN。
3. 按一下**確定**。

針對 ESXi 環境中的每一個管理及容量主機，請遵循下列步驟。

在管理及容量叢集中新增每一個主機之後，請遵循下列步驟：

1. 用滑鼠右鍵按一下**主機群組**功能表，然後選取**建立主機群組...**。
2. 在**名稱**欄位中輸入 'ManagementCluster'，然後選取管理叢集中的所有主機。
3. 按一下**確定**。將會建立我們可指派給特定磁區的主機群組。

針對容量叢集，重複此處理程序。

1. 按一下**儲存空間磁區**功能表。
2. 用滑鼠右鍵按一下 **Mgmt-Lun0** 磁區，然後選取**指派/取消指派主機存取**。
3. 確認 **Mgmt-Lun0** 是下拉功能表中的選項，並選取您在前一個步驟中建立的主機群組。此選項容許管理叢集中的每一個 ESXi 主機存取 Mgmt-Lun0 磁區。請對 **Capacity-LUN0** 執行相同作業

## 步驟 4：在管理/容量叢集上裝載磁區

登入 vSphere Web Client，然後移至 **vCenter Inventory Lists** 下的**主機**。

使用下列步驟，以在 ESXi 主機上裝載磁區：

1. 選取主機，然後按一下**管理、儲存空間** > **儲存空間配接卡**。
2. 選取**目標** > **動態探索** > **新增...**。
3. 在**新增傳送目標伺服器**畫面上，輸入指派給「儲存空間路徑 A」上 QuantaStor 儲存裝置的 IP 位址。
4. 保留 **3260** 作為「埠」，然後按一下**確定**。
5. 按一下**動態探索** > **新增...**。針對「儲存空間路徑 B」，重複步驟 4 及 5。

ESXI 主機已備妥可重新掃描「iSCSI 軟體配接卡」，以探索 Mgmt-Lun0 磁區。

1. 在**儲存空間配接卡**畫面上，選取**重新掃描儲存空間配接卡**圖示（圖 9）。
2. 保留所產生蹦現畫面上的預設選項，然後按一下**確定**。
3. 在探索到磁區之後，按一下**動作、新建資料儲存庫**，並將它格式化為 **VMFS-5**。
4. 確認格式化完成後，按一下**儲存裝置、裝置詳細資料、編輯多重路徑...**。
5. 在**路徑選取原則**中，選取**循環式**，然後按一下**確定**。

既然 Mgmt-Lun0 磁區已連接至單一主機，您必須回到叢集中的其他管理主機，然後重複磁區新增處理程序。不過，您不需要格式化磁區，因為它已格式化為 VMFS-5，並且會在探索之後如此顯示。

## 步驟 5：在 vSphere ESXi 主機中停用延遲的 ACK

將儲存空間 LUN 連接至管理及容量主機之後，需要停用延遲的 ACK。

1. 移至 vSphere 環境，然後選取**儲存空間配接卡** > **iSCSI 軟體配接卡** > **進階選項**。
2. 按一下**編輯**，然後一直捲動至「進階選項」畫面尾端。
3. 清除 **DelayedAck** 勾選框，然後按一下**確定**。

如需 VMware 之延遲 ACK 的相關資訊，請參閱 [VMware 知識庫](https://kb.vmware.com/s/article/1002598)。

您現在可以回到[進階單一網站 VMware 參照架構](/docs/infrastructure/virtualization/advanced-single-site-vmware-reference-architecturesoftlayer.html)錦囊妙計，然後完成環境設定。
